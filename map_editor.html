<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>RPG Map Editor</title>
    <style>
        body { font-family: sans-serif; display: flex; height: 100vh; margin: 0; background: #222; color: #fff; }
        
        /* SOL PANEL (HARÄ°TA) */
        #editor-area { flex-grow: 1; position: relative; overflow: hidden; display: flex; justify-content: center; align-items: center; background: #333; }
        #map-container { position: relative; width: 800px; height: 600px; border: 2px solid #555; background-size: cover; background-position: center; }
        #map-image { width: 100%; height: 100%; object-fit: cover; opacity: 0.5; pointer-events: none; }
        
        /* DÃœÄÃœMLER */
        .node {
            position: absolute; width: 40px; height: 40px; background: #f0e68c; border: 2px solid #fff; border-radius: 50%;
            display: flex; justify-content: center; align-items: center; color: #000; font-weight: bold; cursor: grab; user-select: none; z-index: 10;
            transform: translate(-50%, -50%); /* Merkezi hizalama */
        }
        .node:active { cursor: grabbing; }
        .node.selected { border-color: #f00; box-shadow: 0 0 10px #f00; background: #fff; }
        .node.town { background: #4caf50; }
        .node.campfire { background: #ff9800; }
        .node.encounter { background: #f44336; }
        .node.choice { background: #2196f3; }

        /* BAÄLANTI Ã‡Ä°ZGÄ°LERÄ° (SVG) */
        #connections-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; }
        line { stroke: #fff; stroke-width: 2; opacity: 0.6; }

        /* SAÄ PANEL (AYARLAR) */
        #sidebar { width: 300px; background: #1a1a1a; padding: 20px; border-left: 1px solid #444; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        h2, h3 { color: #f0e68c; margin: 0 0 10px 0; }
        label { font-size: 0.8em; color: #aaa; }
        input, select, textarea { width: 100%; background: #333; border: 1px solid #555; color: #fff; padding: 5px; margin-bottom: 10px; box-sizing: border-box;}
        button { background: #5d4a30; color: #f0e68c; border: 1px solid #7c6843; padding: 10px; cursor: pointer; width: 100%; margin-bottom: 5px; }
        button:hover { background: #6d5a3f; }
        button.delete { background: #8b0000; border-color: #a00; }
        
        #output-area { height: 150px; font-family: monospace; font-size: 0.8em; }
        .hint { font-size: 0.7em; color: #888; margin-bottom: 15px; }
    </style>
</head>
<body>

    <div id="editor-area">
        <div id="map-container">
            <!-- Arka plan resmi -->
            <img id="map-image" src="images/map_background.png" alt="Map BG">
            <!-- Ã‡izgiler -->
            <svg id="connections-layer"></svg>
            <!-- DÃ¼ÄŸÃ¼mler JS ile buraya eklenecek -->
        </div>
    </div>

    <div id="sidebar">
        <h2>ğŸ—ºï¸ Map Editor</h2>
        <p class="hint">Haritaya tÄ±klayarak dÃ¼ÄŸÃ¼m ekle. SÃ¼rÃ¼kleyerek taÅŸÄ±. SaÄŸ taraftan dÃ¼zenle.</p>
        
        <div id="node-properties" style="display: none;">
            <h3>DÃ¼ÄŸÃ¼m AyarlarÄ± (ID: <span id="lbl-id"></span>)</h3>
            
            <label>TÃ¼r:</label>
            <select id="inp-type">
                <option value="encounter">SavaÅŸ (Encounter)</option>
                <option value="choice">SeÃ§im (Choice)</option>
                <option value="town">Åehir (Town)</option>
                <option value="campfire">Kamp AteÅŸi (Campfire)</option>
            </select>

            <label>DÃ¼ÅŸman AdÄ± (Sadece SavaÅŸ ise):</label>
            <input type="text" id="inp-enemy" placeholder="Ã–rn: Goblin SavaÅŸÃ§Ä±sÄ±">

            <label>Hikaye Metni:</label>
            <textarea id="inp-text" rows="3"></textarea>

            <label>BaÄŸlantÄ±lar (Next IDs):</label>
            <div style="display: flex; gap: 5px;">
                <input type="text" id="inp-next" placeholder="Ã–rn: 2, 3" readonly>
                <button onclick="toggleLinkMode()" id="btn-link" style="width: auto;">ğŸ”— BaÄŸla</button>
            </div>
            <p class="hint" id="link-status">BaÄŸlamak iÃ§in 'BaÄŸla'ya bas sonra hedefe tÄ±kla.</p>

            <button onclick="deleteNode()" class="delete">ğŸ—‘ï¸ DÃ¼ÄŸÃ¼mÃ¼ Sil</button>
        </div>

        <div id="no-selection">
            <p>Bir dÃ¼ÄŸÃ¼m seÃ§ilmedi.</p>
        </div>

        <hr>
        <h3>DÄ±ÅŸa Aktar</h3>
        <label>Act Ä°smi (DeÄŸiÅŸken AdÄ±):</label>
        <input type="text" id="inp-act-name" value="ACT_2_MAP">
        <button onclick="generateCode()">Kodu OluÅŸtur</button>
        <textarea id="output-area"></textarea>
    </div>

    <script>
        const mapContainer = document.getElementById('map-container');
        const svgLayer = document.getElementById('connections-layer');
        
        // Veri YapÄ±sÄ±
        let nodes = [];
        let nextId = 1;
        let selectedNodeId = null;
        let isLinkingMode = false;

        // --- HARÄ°TA TIKLAMA (EKLEME) ---
        mapContainer.addEventListener('mousedown', (e) => {
            if (e.target !== mapContainer && e.target.id !== 'map-image' && e.target.id !== 'connections-layer') return;
            
            // Konumu hesapla (YÃ¼zde olarak)
            const rect = mapContainer.getBoundingClientRect();
            const x = ((e.clientX - rect.left) / rect.width) * 100;
            const y = ((e.clientY - rect.top) / rect.height) * 100;

            createNode(x, y);
        });

        function createNode(x, y) {
            const nodeData = {
                id: nextId++,
                type: 'encounter',
                enemy: '',
                text: 'Yeni bir macera noktasÄ±.',
                next: [],
                x: x,
                y: y
            };
            nodes.push(nodeData);
            renderNode(nodeData);
            selectNode(nodeData.id);
        }

        // --- DÃœÄÃœM GÃ–RSELLEÅTÄ°RME ---
        function renderNode(data) {
            const el = document.createElement('div');
            el.className = `node ${data.type}`;
            el.id = `node-${data.id}`;
            el.textContent = data.id;
            el.style.left = data.x + '%';
            el.style.top = data.y + '%';
            
            // SÃ¼rÃ¼kle BÄ±rak MantÄ±ÄŸÄ±
            let isDragging = false;

            el.addEventListener('mousedown', (e) => {
                e.stopPropagation(); // Haritaya tÄ±klamayÄ± engelle
                
                if (isLinkingMode) {
                    completeLink(data.id);
                    return;
                }

                selectNode(data.id);
                isDragging = true;
            });

            window.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                const rect = mapContainer.getBoundingClientRect();
                let newX = ((e.clientX - rect.left) / rect.width) * 100;
                let newY = ((e.clientY - rect.top) / rect.height) * 100;
                
                // SÄ±nÄ±rlarÄ± koru
                newX = Math.max(0, Math.min(100, newX));
                newY = Math.max(0, Math.min(100, newY));

                data.x = newX;
                data.y = newY;
                el.style.left = newX + '%';
                el.style.top = newY + '%';
                drawConnections(); // Ã‡izgileri gÃ¼ncelle
            });

            window.addEventListener('mouseup', () => {
                isDragging = false;
            });

            mapContainer.appendChild(el);
        }

        // --- SEÃ‡Ä°M VE Ã–ZELLÄ°KLER ---
        function selectNode(id) {
            selectedNodeId = id;
            isLinkingMode = false;
            document.getElementById('link-status').textContent = "BaÄŸlamak iÃ§in 'BaÄŸla'ya bas.";

            // GÃ¶rsel seÃ§im
            document.querySelectorAll('.node').forEach(n => n.classList.remove('selected'));
            document.getElementById(`node-${id}`).classList.add('selected');

            // Paneli gÃ¼ncelle
            const node = nodes.find(n => n.id === id);
            document.getElementById('node-properties').style.display = 'block';
            document.getElementById('no-selection').style.display = 'none';

            document.getElementById('lbl-id').textContent = node.id;
            document.getElementById('inp-type').value = node.type;
            document.getElementById('inp-enemy').value = node.enemy || '';
            document.getElementById('inp-text').value = node.text;
            document.getElementById('inp-next').value = node.next.join(', ');
        }

        // --- GÃœNCELLEME ---
        document.getElementById('inp-type').addEventListener('change', (e) => {
            const node = nodes.find(n => n.id === selectedNodeId);
            node.type = e.target.value;
            const el = document.getElementById(`node-${node.id}`);
            el.className = `node selected ${node.type}`; // SÄ±nÄ±fÄ± gÃ¼ncelle
        });

        document.getElementById('inp-enemy').addEventListener('input', (e) => {
            nodes.find(n => n.id === selectedNodeId).enemy = e.target.value;
        });

        document.getElementById('inp-text').addEventListener('input', (e) => {
            nodes.find(n => n.id === selectedNodeId).text = e.target.value;
        });

        // --- BAÄLANTI SÄ°STEMÄ° ---
        function toggleLinkMode() {
            isLinkingMode = !isLinkingMode;
            const status = document.getElementById('link-status');
            if (isLinkingMode) {
                status.textContent = "HEDEF DÃœÄÃœME TIKLA...";
                status.style.color = "#f0e68c";
            } else {
                status.textContent = "Ä°ptal edildi.";
                status.style.color = "#888";
            }
        }

        function completeLink(targetId) {
            if (selectedNodeId === targetId) return; // Kendine baÄŸlama
            const node = nodes.find(n => n.id === selectedNodeId);
            
            if (!node.next.includes(targetId)) {
                node.next.push(targetId);
                // ID sÄ±rasÄ±na gÃ¶re diz ki dÃ¼zgÃ¼n gÃ¶rÃ¼nsÃ¼n
                node.next.sort((a,b) => a-b);
                document.getElementById('inp-next').value = node.next.join(', ');
                drawConnections();
                alert(`${selectedNodeId} -> ${targetId} baÄŸlandÄ±!`);
            }
            
            isLinkingMode = false;
            document.getElementById('link-status').textContent = "BaÄŸlantÄ± baÅŸarÄ±lÄ±.";
            document.getElementById('link-status').style.color = "#888";
        }

        // --- Ã‡Ä°ZGÄ°LERÄ° Ã‡Ä°ZME ---
        function drawConnections() {
            svgLayer.innerHTML = ''; // Temizle
            
            nodes.forEach(node => {
                node.next.forEach(nextId => {
                    const target = nodes.find(n => n.id === nextId);
                    if (target) {
                        const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
                        // YÃ¼zdeleri container boyutuna gÃ¶re piksele Ã§evir
                        const w = mapContainer.offsetWidth;
                        const h = mapContainer.offsetHeight;

                        line.setAttribute('x1', (node.x / 100) * w);
                        line.setAttribute('y1', (node.y / 100) * h);
                        line.setAttribute('x2', (target.x / 100) * w);
                        line.setAttribute('y2', (target.y / 100) * h);
                        svgLayer.appendChild(line);
                    }
                });
            });
        }

        function deleteNode() {
            if (!confirm('Bu dÃ¼ÄŸÃ¼mÃ¼ silmek istediÄŸine emin misin?')) return;
            
            // DÃ¼ÄŸÃ¼mÃ¼ sil
            nodes = nodes.filter(n => n.id !== selectedNodeId);
            // DOM'dan sil
            const el = document.getElementById(`node-${selectedNodeId}`);
            if (el) el.remove();
            
            // DiÄŸer dÃ¼ÄŸÃ¼mlerin baÄŸlantÄ±larÄ±ndan sil
            nodes.forEach(n => {
                n.next = n.next.filter(id => id !== selectedNodeId);
            });

            drawConnections();
            document.getElementById('node-properties').style.display = 'none';
            document.getElementById('no-selection').style.display = 'block';
            selectedNodeId = null;
        }

        // --- KOD OLUÅTURMA (EXPORT) ---
        function generateCode() {
            const varName = document.getElementById('inp-act-name').value;
            
            // JS Objesi formatÄ±nda string oluÅŸtur
            let output = `const ${varName} = {\n`;
            output += `    totalNodes: ${nodes.length},\n`;
            output += `    currentNodeId: ${nodes.length > 0 ? nodes[0].id : 1},\n`;
            output += `    nodes: {\n`;

            nodes.sort((a,b) => a.id - b.id).forEach(node => {
                output += `        ${node.id}: { `;
                output += `type: '${node.type}', `;
                if (node.type === 'encounter') {
                    output += `enemy: '${node.enemy}', `;
                }
                output += `text: "${node.text.replace(/"/g, '\\"')}", `;
                output += `next: [${node.next.join(', ')}], `;
                // Konum bilgilerini css stil dosyasÄ± iÃ§in yorum satÄ±rÄ± veya stil objesi olarak ekleyebiliriz
                // Ama ÅŸimdilik sadece oyun mantÄ±ÄŸÄ±na uygun veriyoruz.
                // CSS konumlarÄ±nÄ± da ayrÄ± bir Ã§Ä±ktÄ± olarak verelim ki map.css'e yapÄ±ÅŸtÄ±rsÄ±n.
                output += `},\n`;
            });

            output += `    }\n};\n\n`;

            // CSS Ã‡Ä±ktÄ±sÄ± Ekleyelim
            output += `/* ${varName} CSS KonumlarÄ± (map.css iÃ§ine ekleyin) */\n`;
            nodes.forEach(node => {
                output += `#node-${node.id} { top: ${Math.round(node.y)}%; left: ${Math.round(node.x)}%; }\n`;
            });

            document.getElementById('output-area').value = output;
        }

        // Ekran boyutu deÄŸiÅŸirse Ã§izgileri gÃ¼ncelle
        window.addEventListener('resize', drawConnections);

    </script>
</body>
</html>